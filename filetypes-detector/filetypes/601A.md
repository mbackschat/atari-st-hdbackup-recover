# Atari ST GEMDOS Executable Files


This document specifies the **exact on-disk structure**, **semantics**, and
**integrity checks** for Atari ST **GEMDOS load modules**, commonly known as
`PRG`, `TOS`, `TTP`, `ACC`, or “executable-style `.O`”.

These files start with magic bytes 0x601A
but need further analysis as laid out in the document.


All these file types share **one single binary format**.  
Differences are determined by **filename extension and launch context**, not by
the file contents.

---

## 1. Header Magic: `0x601A`

The first word of a GEMDOS executable is:

```
0x601A
```


This is a Motorola 68000 instruction:

- `BRA +0x1A` (branch forward 26 bytes)

Execution begins at offset `0x00` and immediately branches to offset `0x1C`,
skipping the program header.

This mechanism:
- avoids a dedicated loader instruction
- makes the header transparent to the CPU
- is mandatory for GEMDOS executables

---

## 2. Header Layout (28 bytes total)

All multi-byte fields are **big-endian**.

| Offset | Size | Field | Meaning |
|------:|----:|------|--------|
| `0x00` | 2 | Magic | `0x601A` |
| `0x02` | 4 | `tlen` | TEXT segment size (stored) |
| `0x06` | 4 | `dlen` | DATA segment size (stored) |
| `0x0A` | 4 | `blen` | BSS size (not stored) |
| `0x0E` | 4 | `slen` | Symbol table size (stored) |
| `0x12` | 4 | Reserved | Usually zero |
| `0x16` | 4 | Reserved | Usually zero |
| `0x1A` | 2 | Flags | Often zero |
| `0x1C` | — | — | Start of TEXT |

**Header size:** `28` bytes

---

## 3. Segment Semantics

### 3.1 TEXT
- Starts at offset `0x1C`
- Length = `tlen`
- Always stored
- Contains executable code

### 3.2 DATA
- Immediately follows TEXT
- Length = `dlen`
- Always stored
- Contains initialized data

### 3.3 BSS
- Length = `blen`
- **Not stored in file**
- Allocated and zeroed by GEMDOS at load time

### 3.4 SYMBOL TABLE (optional)
- Immediately follows DATA
- Length = `slen`
- Present if symbols are retained
- Often uses **14-byte DRI entries**, but format is toolchain-dependent

### 3.5 RELOCATION TABLE (optional)
- Follows the symbol table
- Present if relocation is required
- Encoded as a **delta stream**
- Has **no size field** and **no fixed length**

---

## 4. File Layout


```
+----------------------+ 0x00
| BRA +$1A | 2 bytes
+----------------------+
| Header fields | 26 bytes
+----------------------+ 0x1C ← TEXT start
| TEXT segment | tlen bytes
+----------------------+
| DATA segment | dlen bytes
+----------------------+
| SYMBOL TABLE | slen bytes
+----------------------+
| RELOCATION STREAM | variable length
+----------------------+
```


Only TEXT, DATA, SYMBOLS, and RELOCATIONS are stored.

---

## 5. Relocation Stream Structure

The relocation table begins immediately after the symbol table.

### Encoding rules

1. First longword:
   - Offset of first relocation (relative to TEXT start)
   - `0` means **no relocations**

2. Followed by a stream of bytes:
   - `0x00` → end of relocation table
   - `0x01` → add `254` to current offset
   - `0x02..0xFF` → add value to current offset

Each resulting offset identifies a longword to be relocated.

---

## 6. Integrity and Size Verification

### 6.1 Minimum required size

```
MIN_SIZE = 28 + tlen + dlen + slen
```


If the file is smaller than this, it is **truncated**.

---

### 6.2 Relocation-based exact size verification

To determine the **exact file length**:

1. Start at:

```
reloc_offset = 28 + tlen + dlen + slen
```

2. Parse the relocation stream:
- Consume the initial longword
- Process delta bytes until `0x00` terminator
3. The byte immediately after the terminator is the **exact end of file**

This is the **only reliable way** to compute the exact size.

---

## 7. Validation Rules

A GEMDOS executable is **structurally valid** if:

1. Magic word is `0x601A`
2. TEXT starts at offset `0x1C`
3. `MIN_SIZE <= actual file size`
4. Symbol table fits entirely inside file
5. Relocation stream:
- terminates correctly
- never points outside TEXT+DATA
6. Relocation stream ends exactly at EOF

Failure of any rule indicates:
- truncation
- corruption
- or non-GEMDOS format

---

## 8. Notes on Classification

- PRG / TOS / TTP / ACC are **not different formats**
- Filename extension defines:
- execution environment
- parameter handling
- desktop behavior
- Executable-style `.O` files **use the same structure**
- distinction requires symbol semantics, not header fields

### What you can do heuristically (not 100%)

If you must guess from content:

- ACC guess: look for AES usage patterns (calls to appl_init, evnt_multi, menu_register, etc.). But a normal PRG can also call AES, so it’s not definitive.
- TOS/TTP guess: a .TOS or .TTP often uses GEMDOS console I/O and may not use AES/VDI, but again not definitive.
- Resource-based GEM apps: presence of .RSC loading strings or AES object-tree operations suggests GEM, but still not definitive.


- .O or .LIB: if 0x601A magic is there , If symbol table contains any undefined-external symbol kinds → classify as executable-style .O (link input) with very high confidence


### GEMDOS `.O` (Object / Link-Input) Detection Specification

A GEMDOS 0x601A module is classified as **Object / Link-Input** if **any strong object indicator** is present.

| Result | Meaning |
| --- | --- |
| **OBJECT** | Linkable module, not runnable standalone |
| **EXECUTABLE** | Final GEMDOS runnable |
| **UNKNOWN** | Cannot be determined robustly |

This spec defines **only the OBJECT detection rules**.

File Structure Overview (Relevant Parts):

```
+-----------------------------+
| GEMDOS Header (28 bytes)    |
+-----------------------------+
| TEXT segment (tlen)         |
+-----------------------------+
| DATA segment (dlen)         |
+-----------------------------+
| SYMBOL TABLE (slen)         |  ← critical for object detection
+-----------------------------+
| RELOCATION INFO (variable)  |  ← format differs for object vs executable
+-----------------------------+
```

#### Strong Object Detection Rules

##### Rule O1 — DRI-Style Symbol Table Presence (Structural)

**Condition**

*   `slen > 0`
*   `slen % 14 == 0`

**Interpretation**

*   Symbol table matches the classic **DRI 14-byte symbol entry format**:

```
Offset  Size  Meaning
0x00    8     Symbol name (NUL-padded)
0x08    4     Symbol value (big-endian)
0x0C    1     Symbol type
0x0D    1     Symbol other
```

**Implication**

*   File is _very likely_ a **linkable object module**.

➡️ _Proceed to Rule O2 for confirmation._

##### Rule O2 — Tagged / Relocatable Symbol Values (Semantic)

**Condition**

*   Parsed DRI-style symbols exist
*   A significant portion of symbols satisfy:

```
(symbol_value & 0x80000000) != 0
```

**Interpretation**

*   High-bit–tagged symbol values are **not absolute addresses**
*   They encode relocatable or linker-defined values (e.g. bases, ext refs)

**Implication**

*   **Definitive object module**

> This rule alone correctly classifies GST `.BIN` and DRI `.O` outputs seen in practice.

##### Rule O3 — Undefined External Symbols (Optional, Toolchain-Specific)

**Condition**

*   Symbol table parsed
*   At least one symbol is:
    *   marked _external_
    *   and has _no resolved section/value_

**Interpretation**

*   Module cannot run standalone
*   Requires further linking

**Implication**

*   **Definitive object module**

⚠️ Requires correct decoding of the symbol `type` byte, which is assembler/linker specific.

#### Relocation-Based Object Detection

##### Rule O4 — Invalid Runtime Relocation Delta Stream

**Context**  
Final executables use the **GEMDOS runtime relocation format**:

1.  32-bit offset to first fixup (relative to TEXT)
2.  Bytewise deltas
3.  `0x00` terminator

**Condition**

*   Relocation data:
    *   fails delta-stream validation, OR
    *   fixups exceed `tlen + dlen`, OR
    *   cannot be parsed as `(long + delta bytes + 0x00)`

**Interpretation**

*   Relocation info is **not intended for the GEMDOS loader**
*   Often uses **linker-internal relocation formats**

**Implication**

*   **Object / link-input module**

#### Negative Indicators (Executable Evidence)

These **block OBJECT classification** unless a strong object rule already matched.

##### Rule X1 — Valid Runtime Relocation Stream

*   Relocation delta stream:
    *   parses correctly
    *   stays within TEXT+DATA
    *   terminates with `0x00`
    *   terminator is at EOF (or only known padding follows)

➡️ Strong evidence of **final executable**

##### Rule X2 — No Symbol Table (`slen == 0`)

*   No symbol semantics available
*   Cannot infer object-ness reliably

➡️ **Not sufficient** to claim `.O`


#### Decision Matrix (Priority Order)

**CRITICAL: Rules must be evaluated in priority order. Rule X1 takes precedence.**

1. **Check relocation stream FIRST** (Rule X1 vs Rule O4):
   - If valid runtime relocation (offset < TEXT+DATA) → **EXECUTABLE** (ignore symbol tags)
   - If invalid relocation (offset ≥ TEXT+DATA) → continue to step 2
   - If no relocation (offset == 0) → continue to step 2

2. **Check symbols** (Rule O2):
   - If tagged symbols present → **OBJECT**
   - If tagged symbols + invalid relocation → **OBJECT (high confidence)**

3. **Default**:
   - No strong indicators → **EXECUTABLE**

| Priority | Condition | Result |
| --- | --- | --- |
| **1** | **Rule X1 true** (valid relocation) | **EXECUTABLE** |
| 2 | Rule O2 + Rule O4 (tagged symbols + invalid reloc) | OBJECT (high confidence 98%) |
| 3 | Rule O2 true (tagged symbols) | OBJECT (confidence 95%) |
| 4 | Rule O3 true (undefined externals) | OBJECT |
| 5 | `slen == 0` and reloc invalid | EXECUTABLE (fallback) |
| 6 | No strong indicators | EXECUTABLE (fallback) |


#### Practical Notes

*   **Extensions are irrelevant** (`.BIN`, `.O`, `.PRG` are unreliable)
*   **Relocation format is DECISIVE**: Valid runtime relocation → always EXECUTABLE
*   **Tagged symbols alone are NOT sufficient** for object classification
*   **Real-world case**: Final executables CAN have tagged symbol values if they were linked from .O files with debug symbols retained
*   A **symbol-stripped object module** cannot be reliably distinguished from a malformed executable → classify as EXECUTABLE (fallback)



---

## 9. Summary

- `0x601A` defines GEMDOS load modules
- Header is fixed-size (28 bytes)
- TEXT and DATA are stored
- BSS is not stored
- Symbol table is optional
- Relocation stream is variable-length and must be parsed
- Exact file length is **derivable**, but not stored explicitly

- A GEMDOS `.O` is not defined by its header, but by its **symbol semantics** and **non-runtime relocation encoding**.
In practice:
- **DRI-style symbols + tagged values ⇒ object**
- **Valid GEMDOS relocation stream ⇒ executable**



IMPORTANT:

- Use PRG extension if unsure.

- This 0x601A GEMDOS format is **fundamentally different** from Turbo-C `0x4EFA` containers, which encode the exact file size directly in the header.

